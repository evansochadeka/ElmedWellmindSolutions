<!-- Contact Section -->
<section id="contact" class="contact-section">
    <!-- Background Pattern -->
    <div class="contact-pattern"></div>
    
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Get in Touch</h2>
            <p class="section-subtitle">Reach out to us for support, questions, or to schedule a consultation. We're here to help you on your wellness journey.</p>
        </div>
        
        <!-- Email Status Messages -->
        <div id="formMessages" style="display: none;"></div>
        
        <div class="contact-wrapper">
            <!-- Contact Information -->
            <div class="contact-info">
                <div class="contact-card">
                    <div class="contact-icon">
                        <i class="fas fa-headset"></i>
                    </div>
                    <h3>Contact Information</h3>
                    <p>We're here to listen and support you every step of the way.</p>
                    
                    <div class="contact-details">
                        <div class="contact-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <h4>Our Location</h4>
                                <p>Kahawa Wendani, Thika Road<br>Nairobi, Kenya</p>
                            </div>
                        </div>
                        
                        <div class="contact-item">
                            <i class="fas fa-phone"></i>
                            <div>
                                <h4>Phone Number</h4>
                                <p><a href="tel:+254759226354">+254 759 226354</a></p>
                                <small>Available 24/7 for emergencies</small>
                            </div>
                        </div>
                        
                        <div class="contact-item">
                            <i class="fas fa-envelope"></i>
                            <div>
                                <h4>Email Address</h4>
                                <p><a href="mailto:elijahokware@gmail.com">elijahokware@gmail.com</a></p>
                                <small>Response within 24 hours</small>
                            </div>
                        </div>
                        
                        <div class="contact-item">
                            <i class="fab fa-whatsapp"></i>
                            <div>
                                <h4>WhatsApp Support</h4>
                                <p><a href="https://wa.me/254759226354" target="_blank">+254 759 226354</a></p>
                                <small>Instant chat support</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Contact Buttons -->
                    <div class="quick-contact">
                        <h4><i class="fas fa-bolt"></i> Quick Actions</h4>
                        <div class="quick-buttons">
                            <button class="quick-btn whatsapp-btn" onclick="window.open('https://wa.me/254759226354', '_blank')">
                                <i class="fab fa-whatsapp"></i> WhatsApp Now
                            </button>
                            <button class="quick-btn call-btn" onclick="window.location.href='tel:+254759226354'">
                                <i class="fas fa-phone"></i> Call Now
                            </button>
                            <button class="quick-btn email-btn" onclick="window.location.href='mailto:elijahokware@gmail.com'">
                                <i class="fas fa-envelope"></i> Email Directly
                            </button>
                            <button class="quick-btn location-btn" onclick="window.open('https://maps.google.com/?q=Kahawa+Wendani+Thika+Road+Nairobi', '_blank')">
                                <i class="fas fa-map-marker-alt"></i> Get Directions
                            </button>
                        </div>
                    </div>
                    
                    <!-- NEW: Office Hours -->
                    <div class="office-hours">
                        <h4><i class="fas fa-clock"></i> Office Hours</h4>
                        <div class="hours-list">
                            <div class="hour-item">
                                <span>Monday - Friday</span>
                                <span>8:00 AM - 8:00 PM</span>
                            </div>
                            <div class="hour-item">
                                <span>Saturday</span>
                                <span>9:00 AM - 4:00 PM</span>
                            </div>
                            <div class="hour-item">
                                <span>Sunday</span>
                                <span>Emergency Only</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="emergency-contact">
                        <h4><i class="fas fa-exclamation-triangle"></i> Emergency Contacts</h4>
                        <p>If you're in crisis, contact:</p>
                        <ul>
                            <li><strong>Nairobi Women's Hospital Crisis Line:</strong> 0800 720 720</li>
                            <li><strong>Kenya Red Cross:</strong> 1199</li>
                            <li><strong>Emergency Police:</strong> 999 or 112</li>
                            <li><strong>Befrienders Kenya:</strong> 0722 178 178</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Contact Form -->
            <div class="contact-form-wrapper">
                <div class="contact-form-card">
                    <h3>Send Us a Message</h3>
                    <p>Fill out the form below and we'll get back to you as soon as possible.</p>
                    
                    <!-- Email sending status indicator -->
                    <div id="emailStatus" style="display:none; margin-bottom: 20px; padding: 10px; border-radius: 8px; text-align: center;"></div>
                    
                    <form id="contactForm" class="contact-form">
                        <div class="form-group">
                            <label for="name">
                                <i class="fas fa-user"></i> Full Name
                            </label>
                            <input type="text" id="name" name="name" required 
                                   placeholder="Enter your full name">
                            <div class="input-feedback"></div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="email">
                                    <i class="fas fa-envelope"></i> Email Address
                                </label>
                                <input type="email" id="email" name="email" required 
                                       placeholder="Enter your email">
                                <div class="input-feedback"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="phone">
                                    <i class="fas fa-phone"></i> Phone Number
                                </label>
                                <input type="tel" id="phone" name="phone" 
                                       placeholder="Optional">
                                <div class="input-feedback"></div>
                            </div>
                        </div>
                        
                        <!-- NEW: Age Range -->
                        <div class="form-group">
                            <label for="age">
                                <i class="fas fa-birthday-cake"></i> Age Range
                            </label>
                            <select id="age" name="age">
                                <option value="">Select age range</option>
                                <option value="Under 18">Under 18</option>
                                <option value="18-25">18-25</option>
                                <option value="26-35">26-35</option>
                                <option value="36-50">36-50</option>
                                <option value="51-65">51-65</option>
                                <option value="Over 65">Over 65</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="subject">
                                <i class="fas fa-tag"></i> Subject
                            </label>
                            <select id="subject" name="subject" required>
                                <option value="">Select a topic</option>
                                <option value="General Inquiry">General Inquiry</option>
                                <option value="Appointment Booking">Appointment Booking</option>
                                <option value="Therapy/Counseling">Therapy/Counseling</option>
                                <option value="Group Sessions">Group Sessions</option>
                                <option value="Corporate Services">Corporate Services</option>
                                <option value="Emergency Support">Emergency Support</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="input-feedback"></div>
                        </div>
                        
                        <!-- NEW: Preferred Contact Method -->
                        <div class="form-group">
                            <label>
                                <i class="fas fa-comments"></i> Preferred Contact Method
                            </label>
                            <div class="contact-methods">
                                <label class="method-option">
                                    <input type="checkbox" name="contactMethod[]" value="Email" checked>
                                    <i class="fas fa-envelope"></i> Email
                                </label>
                                <label class="method-option">
                                    <input type="checkbox" name="contactMethod[]" value="Phone">
                                    <i class="fas fa-phone"></i> Phone
                                </label>
                                <label class="method-option">
                                    <input type="checkbox" name="contactMethod[]" value="WhatsApp">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="message">
                                <i class="fas fa-comment-dots"></i> Your Message
                            </label>
                            <textarea id="message" name="message" rows="5" required 
                                      placeholder="How can we help you today?"></textarea>
                            <div class="char-count">
                                <span id="charCount">0</span>/500 characters
                            </div>
                            <div class="input-feedback"></div>
                        </div>
                        
                        <!-- Priority Selection -->
                        <div class="form-group">
                            <label>
                                <i class="fas fa-flag"></i> Priority Level
                            </label>
                            <div class="priority-selector">
                                <label class="priority-option">
                                    <input type="radio" name="priority" value="Low" checked>
                                    <span class="priority-dot low"></span>
                                    Low
                                </label>
                                <label class="priority-option">
                                    <input type="radio" name="priority" value="Medium">
                                    <span class="priority-dot medium"></span>
                                    Medium
                                </label>
                                <label class="priority-option">
                                    <input type="radio" name="priority" value="High">
                                    <span class="priority-dot high"></span>
                                    High
                                </label>
                                <label class="priority-option">
                                    <input type="radio" name="priority" value="Emergency">
                                    <span class="priority-dot emergency"></span>
                                    Emergency
                                </label>
                            </div>
                        </div>
                        
                        <!-- NEW: Upload File (Optional) -->
                        <div class="form-group">
                            <label for="attachment">
                                <i class="fas fa-paperclip"></i> Attachment (Optional)
                            </label>
                            <input type="file" id="attachment" name="attachment" 
                                   accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                                   style="padding: 10px; border: 2px dashed #e0e0e0; border-radius: 8px; width: 100%;">
                            <small style="display: block; margin-top: 5px; color: #888;">Max file size: 5MB (PDF, DOC, JPG, PNG)</small>
                        </div>
                        
                        <!-- Privacy Consent -->
                        <div class="privacy-consent">
                            <input type="checkbox" id="privacy" name="privacy" required>
                            <label for="privacy">
                                I understand that this information will be kept confidential and secure according to our privacy policy.
                            </label>
                            <div class="input-feedback"></div>
                        </div>
                        
                        <!-- NEW: CAPTCHA -->
                        <div class="captcha">
                            <div class="captcha-question">
                                <span id="captchaText">5 + 3 = </span>
                                <input type="text" id="captchaAnswer" placeholder="?" maxlength="2" required>
                            </div>
                            <button type="button" class="btn-refresh-captcha" onclick="generateCaptcha()">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                        
                        <div class="form-submit">
                            <button type="submit" class="btn-submit" id="submitBtn">
                                <i class="fas fa-paper-plane"></i>
                                <span class="btn-text">Send Message</span>
                                <span class="submit-loader"></span>
                            </button>
                            <p class="form-note">
                                <i class="fas fa-lock"></i> Your information is protected and encrypted
                            </p>
                        </div>
                    </form>
                    
                    <!-- Auto-response timer -->
                    <div class="auto-response-info">
                        <i class="fas fa-clock"></i>
                        <span>Average response time: <strong>2-4 hours</strong></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Contact Status Indicator -->
        <div class="contact-status">
            <div class="status-item online">
                <i class="fas fa-circle"></i>
                <span>Email System: <strong>Active</strong></span>
            </div>
            <div class="status-item">
                <i class="fas fa-check-circle"></i>
                <span>Messages encrypted</span>
            </div>
            <div class="status-item">
                <i class="fas fa-shield-alt"></i>
                <span>Privacy protected</span>
            </div>
            <div class="status-item">
                <i class="fas fa-user-md"></i>
                <span>Licensed therapists</span>
            </div>
        </div>
        
        <!-- Mental Health Resources -->
        <div class="resources-section">
            <h3>Mental Health Resources</h3>
            <div class="resources-grid">
                <div class="resource-card">
                    <div class="resource-icon">
                        <i class="fas fa-heart"></i>
                    </div>
                    <h4>Coping Strategies</h4>
                    <p>Learn healthy ways to manage stress, anxiety, and depression.</p>
                    <a href="#resources" class="resource-link">Explore Strategies</a>
                </div>
                
                <div class="resource-card">
                    <div class="resource-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h4>Support Groups</h4>
                    <p>Join our community for shared experiences and mutual support.</p>
                    <a href="#community" class="resource-link">Join Community</a>
                </div>
                
                <div class="resource-card">
                    <div class="resource-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <h4>Self-Help Guides</h4>
                    <p>Access free resources and guides for mental wellness.</p>
                    <a href="#resources" class="resource-link">Download Guides</a>
                </div>
                
                <div class="resource-card">
                    <div class="resource-icon">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <h4>Crisis App</h4>
                    <p>Download our mobile app for immediate support tools.</p>
                    <a href="#app" class="resource-link">Get the App</a>
                </div>
            </div>
        </div>
        
        <!-- NEW: Crisis Support Widget -->
        <div class="crisis-support">
            <div class="crisis-header">
                <i class="fas fa-first-aid"></i>
                <h3>Immediate Crisis Support</h3>
            </div>
            <div class="crisis-actions">
                <button class="crisis-btn" onclick="window.open('tel:0800720720')">
                    <i class="fas fa-phone-volume"></i>
                    <span>Crisis Hotline</span>
                    <small>0800 720 720</small>
                </button>
                <button class="crisis-btn" onclick="window.open('https://wa.me/254759226354', '_blank')">
                    <i class="fab fa-whatsapp"></i>
                    <span>WhatsApp Support</span>
                    <small>Instant chat</small>
                </button>
                <button class="crisis-btn" onclick="showSelfHelpModal()">
                    <i class="fas fa-hands-helping"></i>
                    <span>Self-Help Tools</span>
                    <small>Immediate relief</small>
                </button>
                <button class="crisis-btn" onclick="window.open('https://www.mentalhealth.gov/get-help/immediate-help', '_blank')">
                    <i class="fas fa-globe"></i>
                    <span>Global Resources</span>
                    <small>Worldwide support</small>
                </button>
            </div>
        </div>
        
        <!-- FAQ Section -->
        <div class="faq-section">
            <h3>Frequently Asked Questions</h3>
            <div class="faq-container">
                <div class="faq-item">
                    <button class="faq-question">
                        How quickly will I get a response?
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="faq-answer">
                        <p>We aim to respond to all inquiries within 24 hours. For emergencies, please call our support line or use the WhatsApp chat for immediate assistance.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <button class="faq-question">
                        Is my information confidential?
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="faq-answer">
                        <p>Yes, all information shared with us is strictly confidential and protected under professional ethical guidelines and privacy laws.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <button class="faq-question">
                        What are your consultation fees?
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="faq-answer">
                        <p>We offer a sliding scale fee structure based on income. Contact us for specific pricing or to discuss financial assistance options.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <button class="faq-question">
                        Do you offer online sessions?
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="faq-answer">
                        <p>Yes, we offer both in-person and virtual consultations via secure video platforms to accommodate your needs and preferences.</p>
                    </div>
                </div>
                
                <!-- NEW FAQ Items -->
                <div class="faq-item">
                    <button class="faq-question">
                        Do you accept insurance?
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="faq-answer">
                        <p>We work with most major insurance providers. Please contact us with your insurance details and we'll verify your coverage.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <button class="faq-question">
                        What languages do you offer services in?
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="faq-answer">
                        <p>We offer services in English, Swahili, and several local dialects. Please specify your language preference when contacting us.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- NEW: Testimonials Section -->
        <div class="testimonials-section">
            <h3>What Our Clients Say</h3>
            <div class="testimonials-slider">
                <div class="testimonial-card">
                    <div class="testimonial-content">
                        "The support I received was life-changing. The team was compassionate and professional throughout my journey."
                    </div>
                    <div class="testimonial-author">
                        <strong>Sarah M.</strong>
                        <span>Nairobi</span>
                    </div>
                </div>
                <div class="testimonial-card">
                    <div class="testimonial-content">
                        "Online sessions made therapy accessible for me. The counselors are excellent and very understanding."
                    </div>
                    <div class="testimonial-author">
                        <strong>James K.</strong>
                        <span>Mombasa</span>
                    </div>
                </div>
                <div class="testimonial-card">
                    <div class="testimonial-content">
                        "Emergency support saved me during a difficult time. Immediate response and genuine care."
                    </div>
                    <div class="testimonial-author">
                        <strong>Grace W.</strong>
                        <span>Kisumu</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Contact History / Saved Messages -->
        <div class="contact-history">
            <h3><i class="fas fa-history"></i> Recent Messages</h3>
            <div class="history-list" id="historyList">
                <!-- Messages will be loaded here from localStorage -->
            </div>
            <div class="history-actions">
                <button class="btn-clear-history" onclick="clearHistory()">
                    <i class="fas fa-trash"></i> Clear History
                </button>
                <button class="btn-export-history" onclick="exportHistory()">
                    <i class="fas fa-download"></i> Export History
                </button>
            </div>
        </div>
        
        <!-- Map Section -->
        <div class="map-section">
            <h3>Our Location</h3>
            <div class="map-container">
                <div class="map-placeholder">
                    <i class="fas fa-map-marked-alt"></i>
                    <p>Kahawa Wendani, Thika Road, Nairobi</p>
                    <a href="https://maps.google.com/?q=Kahawa+Wendani+Thika+Road+Nairobi" target="_blank" class="btn-map">
                        <i class="fas fa-directions"></i> Get Directions
                    </a>
                </div>
                <!-- Estimated Travel Time -->
                <div class="travel-time">
                    <i class="fas fa-car"></i>
                    <span>Estimated travel time from city center: <strong>30-45 minutes</strong></span>
                </div>
                <!-- NEW: Transportation Options -->
                <div class="transport-options">
                    <h4><i class="fas fa-bus"></i> Transportation Options</h4>
                    <div class="transport-list">
                        <div class="transport-item">
                            <i class="fas fa-bus"></i>
                            <span>Matatu: Route 111</span>
                        </div>
                        <div class="transport-item">
                            <i class="fas fa-taxi"></i>
                            <span>Taxi: Uber/Bolt available</span>
                        </div>
                        <div class="transport-item">
                            <i class="fas fa-parking"></i>
                            <span>Free parking available</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- NEW: Live Chat Widget -->
        <div class="live-chat-widget" id="liveChatWidget">
            <button class="chat-toggle" id="chatToggle">
                <i class="fas fa-comments"></i>
                <span>Live Chat</span>
                <span class="chat-badge">Online</span>
            </button>
            <div class="chat-window" id="chatWindow">
                <div class="chat-header">
                    <h4><i class="fas fa-headset"></i> Live Support</h4>
                    <button class="chat-close">&times;</button>
                </div>
                <div class="chat-body" id="chatBody">
                    <div class="chat-message bot">
                        <div class="message-content">
                            Hello! I'm here to help. How can I assist you today?
                        </div>
                        <div class="message-time">Just now</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Type your message...">
                    <button id="sendChat"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Depression Help Resources Modal -->
<div id="depression-help" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Depression Support Resources</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="resource-list">
                <div class="resource-item">
                    <h4><i class="fas fa-heartbeat"></i> Immediate Help</h4>
                    <p>If you're having thoughts of self-harm, please call emergency services immediately or reach out to:</p>
                    <ul>
                        <li>Nairobi Women's Hospital Crisis Line: <strong>0800 720 720</strong></li>
                        <li>Befrienders Kenya: <strong>0722 178 178</strong></li>
                        <li>Emergency Services: <strong>999 or 112</strong></li>
                    </ul>
                </div>
                
                <div class="resource-item">
                    <h4><i class="fas fa-hands-helping"></i> Coping Strategies</h4>
                    <p>Try these techniques when feeling overwhelmed:</p>
                    <ul>
                        <li>Practice deep breathing exercises</li>
                        <li>Reach out to a trusted friend or family member</li>
                        <li>Engage in light physical activity</li>
                        <li>Practice mindfulness meditation</li>
                    </ul>
                </div>
                
                <div class="resource-item">
                    <h4><i class="fas fa-calendar-check"></i> Self-Care Tips</h4>
                    <ul>
                        <li>Establish a daily routine</li>
                        <li>Get adequate sleep</li>
                        <li>Eat balanced meals</li>
                        <li>Limit alcohol and caffeine</li>
                        <li>Spend time in nature</li>
                    </ul>
                </div>
                
                <div class="resource-item">
                    <h4><i class="fas fa-book-medical"></i> Professional Help</h4>
                    <p>Remember: Depression is treatable. Seeking professional help is a sign of strength, not weakness.</p>
                    <a href="#contact" class="btn btn-primary">Schedule a Consultation</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NEW: Self-Help Modal -->
<div id="selfHelpModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-hands-helping"></i> Immediate Self-Help Tools</h3>
            <button class="modal-close" onclick="closeSelfHelpModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="self-help-tools">
                <div class="tool-card breathing-tool" onclick="startBreathingExercise()">
                    <i class="fas fa-wind"></i>
                    <h4>Breathing Exercise</h4>
                    <p>4-7-8 breathing technique for immediate calm</p>
                </div>
                <div class="tool-card grounding-tool" onclick="startGroundingExercise()">
                    <i class="fas fa-mountain"></i>
                    <h4>Grounding Exercise</h4>
                    <p>5-4-3-2-1 technique for anxiety relief</p>
                </div>
                <div class="tool-card audio-tool" onclick="playCalmingAudio()">
                    <i class="fas fa-music"></i>
                    <h4>Calming Audio</h4>
                    <p>Soothing sounds for relaxation</p>
                </div>
                <div class="tool-card resources-tool" onclick="window.open('#resources', '_blank')">
                    <i class="fas fa-book-open"></i>
                    <h4>Resources Library</h4>
                    <p>Access self-help guides and articles</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* All original CSS styles remain */
    /* Adding new styles for enhanced features */
    
    /* Office Hours */
    .office-hours {
        background: #f0f7ff;
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        border-left: 4px solid #6c63ff;
    }
    
    .office-hours h4 {
        color: #1a237e;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .hours-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .hour-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(108, 99, 255, 0.1);
    }
    
    .hour-item:last-child {
        border-bottom: none;
    }
    
    .hour-item span:first-child {
        color: #555;
    }
    
    .hour-item span:last-child {
        color: #6c63ff;
        font-weight: 600;
    }
    
    /* Quick Contact Buttons Enhancement */
    .quick-buttons {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
    }
    
    @media (max-width: 768px) {
        .quick-buttons {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    .location-btn {
        background: #9c27b0;
        color: white;
    }
    
    /* Contact Methods */
    .contact-methods {
        display: flex;
        gap: 15px;
        margin-top: 10px;
        flex-wrap: wrap;
    }
    
    .method-option {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        transition: all 0.3s;
        background: white;
    }
    
    .method-option:hover {
        border-color: #6c63ff;
        background: #f8f9ff;
        transform: translateY(-2px);
    }
    
    .method-option input:checked + i {
        color: #6c63ff;
    }
    
    .method-option input:checked ~ .method-option {
        border-color: #6c63ff;
        background: #f8f9ff;
    }
    
    /* File Upload */
    input[type="file"] {
        cursor: pointer;
    }
    
    input[type="file"]:hover {
        border-color: #6c63ff;
        background: #f8f9ff;
    }
    
    /* CAPTCHA */
    .captcha {
        display: flex;
        align-items: center;
        gap: 15px;
        margin: 20px 0;
        padding: 15px;
        background: #f8f9ff;
        border-radius: 10px;
        border: 1px solid #e8eaff;
    }
    
    .captcha-question {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    #captchaText {
        font-size: 1.2rem;
        font-weight: 600;
        color: #1a237e;
        background: white;
        padding: 8px 15px;
        border-radius: 5px;
        border: 2px solid #e0e0e0;
    }
    
    #captchaAnswer {
        width: 60px;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 5px;
        font-size: 1.1rem;
        text-align: center;
    }
    
    .btn-refresh-captcha {
        background: #6c63ff;
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-refresh-captcha:hover {
        background: #4a43d4;
        transform: rotate(180deg);
    }
    
    /* Crisis Support */
    .crisis-support {
        background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        border-radius: 20px;
        padding: 40px;
        margin: 60px 0;
        color: white;
        text-align: center;
    }
    
    .crisis-header {
        margin-bottom: 30px;
    }
    
    .crisis-header i {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    .crisis-header h3 {
        font-size: 2rem;
        margin: 0;
    }
    
    .crisis-actions {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
    }
    
    @media (max-width: 992px) {
        .crisis-actions {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 576px) {
        .crisis-actions {
            grid-template-columns: 1fr;
        }
    }
    
    .crisis-btn {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 15px;
        padding: 25px 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        transition: all 0.3s;
        color: #333;
    }
    
    .crisis-btn:hover {
        background: white;
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    .crisis-btn i {
        font-size: 2rem;
        color: #ff6b6b;
    }
    
    .crisis-btn span {
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .crisis-btn small {
        color: #666;
        font-size: 0.9rem;
    }
    
    /* Testimonials */
    .testimonials-section {
        margin: 80px 0;
    }
    
    .testimonials-section h3 {
        color: #1a237e;
        font-size: 2.2rem;
        margin-bottom: 40px;
        text-align: center;
    }
    
    .testimonials-slider {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
    }
    
    .testimonial-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border: 1px solid rgba(108, 99, 255, 0.1);
        transition: transform 0.3s;
    }
    
    .testimonial-card:hover {
        transform: translateY(-10px);
    }
    
    .testimonial-content {
        font-style: italic;
        color: #555;
        line-height: 1.6;
        margin-bottom: 20px;
        position: relative;
        padding-left: 20px;
    }
    
    .testimonial-content:before {
        content: '"';
        position: absolute;
        left: 0;
        top: -10px;
        font-size: 3rem;
        color: #6c63ff;
        opacity: 0.3;
    }
    
    .testimonial-author {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid #eee;
        padding-top: 15px;
    }
    
    .testimonial-author strong {
        color: #1a237e;
    }
    
    .testimonial-author span {
        color: #666;
        font-size: 0.9rem;
    }
    
    /* Contact History Actions */
    .history-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
    }
    
    .btn-clear-history,
    .btn-export-history {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .btn-clear-history {
        background: #ff6b6b;
        color: white;
    }
    
    .btn-clear-history:hover {
        background: #ff4757;
    }
    
    .btn-export-history {
        background: #36d1dc;
        color: white;
    }
    
    .btn-export-history:hover {
        background: #2bbfd8;
    }
    
    /* Transportation Options */
    .transport-options {
        margin-top: 30px;
        text-align: center;
    }
    
    .transport-options h4 {
        color: #1a237e;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    
    .transport-list {
        display: flex;
        justify-content: center;
        gap: 30px;
        flex-wrap: wrap;
    }
    
    .transport-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        background: #f8f9ff;
        border-radius: 50px;
        border: 1px solid #e8eaff;
    }
    
    .transport-item i {
        color: #6c63ff;
    }
    
    /* Self-Help Tools Modal */
    .self-help-tools {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-top: 20px;
    }
    
    @media (max-width: 576px) {
        .self-help-tools {
            grid-template-columns: 1fr;
        }
    }
    
    .tool-card {
        background: #f8f9ff;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
    }
    
    .tool-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(108, 99, 255, 0.15);
        border-color: #6c63ff;
    }
    
    .tool-card i {
        font-size: 2.5rem;
        margin-bottom: 15px;
        color: #6c63ff;
    }
    
    .tool-card h4 {
        color: #1a237e;
        margin-bottom: 10px;
    }
    
    .tool-card p {
        color: #666;
        font-size: 0.9rem;
    }
    
    /* Breathing Exercise Animation */
    .breathing-animation {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(108, 99, 255, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        color: white;
    }
    
    .breathing-circle {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        border: 5px solid white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 40px;
        animation: breathe 8s infinite ease-in-out;
    }
    
    @keyframes breathe {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.5); }
    }
    
    .breathing-instruction {
        font-size: 1.5rem;
        text-align: center;
        margin-bottom: 20px;
    }
    
    .breathing-timer {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 30px;
    }
    
    .btn-stop-breathing {
        background: white;
        color: #6c63ff;
        border: none;
        padding: 12px 30px;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-stop-breathing:hover {
        background: #f8f9ff;
        transform: translateY(-2px);
    }
    
    /* Live Chat Widget */
    .live-chat-widget {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
    }
    
    .chat-toggle {
        background: linear-gradient(135deg, #6c63ff, #36d1dc);
        color: white;
        border: none;
        padding: 15px 25px;
        border-radius: 50px;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(108, 99, 255, 0.3);
        transition: all 0.3s;
    }
    
    .chat-toggle:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(108, 99, 255, 0.4);
    }
    
    .chat-badge {
        background: #4CAF50;
        color: white;
        padding: 3px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        animation: pulse 2s infinite;
    }
    
    .chat-window {
        position: absolute;
        bottom: 70px;
        right: 0;
        width: 350px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        display: none;
        overflow: hidden;
        animation: slideUp 0.3s ease;
    }
    
    .chat-window.active {
        display: block;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Contact Status Enhancement */
    .contact-status {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin: 40px 0;
        flex-wrap: wrap;
    }
    
    .status-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        background: #f8f9ff;
        border-radius: 50px;
        border: 2px solid #e8eaff;
        transition: all 0.3s;
    }
    
    .status-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(108, 99, 255, 0.1);
    }
    
    .status-item i {
        color: #6c63ff;
    }
    
    .status-item.online i {
        color: #4CAF50;
        animation: pulse 2s infinite;
    }
    
    .status-item span {
        color: #555;
        font-size: 0.95rem;
    }
    
    .status-item strong {
        color: #1a237e;
    }
</style>

<script>
// ============================================
// EMAILJS CONFIGURATION WITH YOUR CREDENTIALS
// ============================================
const EMAILJS_CONFIG = {
    PUBLIC_KEY: "-jbh4-jMFMMjvpP-W",
    SERVICE_ID: "service_b7urskv",
    TEMPLATE_ID: "template_8zt7r2l"
};

// ============================================

document.addEventListener('DOMContentLoaded', function() {
    // Initialize EmailJS
    if (EMAILJS_CONFIG.PUBLIC_KEY) {
        try {
            emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
            console.log("✅ EmailJS initialized successfully");
            updateStatusIndicator('active');
        } catch (error) {
            console.error("❌ EmailJS initialization failed:", error);
            updateStatusIndicator('error');
        }
    }
    
    // Restore all original features and add new ones
    
    // 1. Character counter
    const messageTextarea = document.getElementById('message');
    const charCount = document.getElementById('charCount');
    
    if (messageTextarea && charCount) {
        messageTextarea.addEventListener('input', function() {
            const length = this.value.length;
            charCount.textContent = length;
            
            if (length > 500) {
                charCount.style.color = '#ff6b6b';
                this.style.borderColor = '#ff6b6b';
            } else if (length > 400) {
                charCount.style.color = '#ffd166';
                this.style.borderColor = '#ffd166';
            } else {
                charCount.style.color = '#888';
                this.style.borderColor = '#e0e0e0';
            }
            
            // Auto-expand textarea
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    }
    
    // 2. FAQ toggle functionality
    const faqQuestions = document.querySelectorAll('.faq-question');
    
    faqQuestions.forEach(question => {
        question.addEventListener('click', function() {
            const faqItem = this.parentElement;
            const isActive = faqItem.classList.contains('active');
            
            document.querySelectorAll('.faq-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (!isActive) {
                faqItem.classList.add('active');
            }
        });
    });
    
    // 3. Form validation
    setupRealTimeValidation();
    
    // 4. CAPTCHA generation
    generateCaptcha();
    
    // 5. Contact form submission
    setupContactForm();
    
    // 6. Live chat widget
    setupLiveChat();
    
    // 7. Load contact history
    loadContactHistory();
    
    // 8. Emergency contact animations
    setupEmergencyContacts();
    
    // 9. Quick button animations
    setupQuickButtons();
    
    // 10. Testimonials auto-rotation
    setupTestimonials();
    
    // 11. Check if EmailJS is configured
    checkEmailJSConfiguration();
});

// ====================
// ENHANCED FUNCTIONS
// ====================

// 1. Real-time form validation
function setupRealTimeValidation() {
    const inputs = document.querySelectorAll('#contactForm input, #contactForm textarea, #contactForm select');
    
    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            validateField(this);
        });
        
        input.addEventListener('input', function() {
            clearFieldError(this);
            
            // Real-time validation for email
            if (this.type === 'email' && this.value) {
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailPattern.test(this.value)) {
                    showFieldError(this, 'Please enter a valid email address');
                } else {
                    showFieldSuccess(this);
                }
            }
        });
    });
}

// 2. CAPTCHA system
function generateCaptcha() {
    const num1 = Math.floor(Math.random() * 10) + 1;
    const num2 = Math.floor(Math.random() * 10) + 1;
    const operator = ['+', '-', '×'][Math.floor(Math.random() * 3)];
    
    let answer;
    switch(operator) {
        case '+': answer = num1 + num2; break;
        case '-': answer = num1 - num2; break;
        case '×': answer = num1 * num2; break;
    }
    
    localStorage.setItem('captchaAnswer', answer.toString());
    document.getElementById('captchaText').textContent = `${num1} ${operator} ${num2} = `;
    document.getElementById('captchaAnswer').value = '';
}

function validateCaptcha() {
    const userAnswer = document.getElementById('captchaAnswer').value.trim();
    const correctAnswer = localStorage.getItem('captchaAnswer');
    return userAnswer === correctAnswer;
}

// 3. Enhanced contact form
function setupContactForm() {
    const contactForm = document.getElementById('contactForm');
    if (!contactForm) return;
    
    contactForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validate all fields
        if (!validateAllFields()) return;
        
        // Validate CAPTCHA
        if (!validateCaptcha()) {
            showNotification('Please solve the CAPTCHA correctly', 'error');
            generateCaptcha();
            return;
        }
        
        // Show loading state
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.querySelector('.btn-text').textContent = 'Sending...';
        submitBtn.querySelector('.submit-loader').style.display = 'inline-block';
        
        // Collect form data
        const formData = {
            from_name: document.getElementById('name').value.trim(),
            from_email: document.getElementById('email').value.trim(),
            phone: document.getElementById('phone').value.trim() || 'Not provided',
            age: document.getElementById('age').value,
            subject: document.getElementById('subject').value,
            message: document.getElementById('message').value.trim(),
            priority: document.querySelector('input[name="priority"]:checked').value,
            contact_method: Array.from(document.querySelectorAll('input[name="contactMethod[]"]:checked'))
                .map(cb => cb.value).join(', '),
            timestamp: new Date().toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })
        };
        
        // Handle file attachment
        const fileInput = document.getElementById('attachment');
        if (fileInput.files.length > 0) {
            formData.has_attachment = 'Yes';
            formData.attachment_name = fileInput.files[0].name;
        }
        
        try {
            // Send email using EmailJS
            const response = await emailjs.send(
                EMAILJS_CONFIG.SERVICE_ID,
                EMAILJS_CONFIG.TEMPLATE_ID,
                formData
            );
            
            if (response.status === 200) {
                // Success
                showNotification('Message sent successfully! We\'ll respond within 24 hours.', 'success');
                
                // Save to history
                saveMessageToHistory(formData);
                
                // Reset form
                contactForm.reset();
                document.getElementById('charCount').textContent = '0';
                generateCaptcha();
                
                // Play success sound
                playSuccessSound();
                
            } else {
                throw new Error('Email sending failed');
            }
            
        } catch (error) {
            console.error('Email sending error:', error);
            
            // Try fallback
            try {
                await sendWithFallback(formData);
                showNotification('Message sent via backup method!', 'success');
            } catch (fallbackError) {
                // Save offline
                saveMessageToPending(formData);
                showNotification('Message saved offline. Will send when online.', 'warning');
            }
            
        } finally {
            // Reset button
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = false;
            submitBtn.querySelector('.btn-text').textContent = 'Send Message';
            submitBtn.querySelector('.submit-loader').style.display = 'none';
        }
    });
}

// 4. Live chat widget
function setupLiveChat() {
    const chatToggle = document.getElementById('chatToggle');
    const chatWindow = document.getElementById('chatWindow');
    const chatClose = document.querySelector('.chat-close');
    const sendChat = document.getElementById('sendChat');
    const chatInput = document.getElementById('chatInput');
    const chatBody = document.getElementById('chatBody');
    
    if (chatToggle && chatWindow) {
        chatToggle.addEventListener('click', () => {
            chatWindow.classList.toggle('active');
        });
        
        if (chatClose) {
            chatClose.addEventListener('click', () => {
                chatWindow.classList.remove('active');
            });
        }
        
        if (sendChat && chatInput) {
            sendChat.addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
        }
    }
    
    // Auto-welcome message
    setTimeout(() => {
        if (!localStorage.getItem('chatWelcomed')) {
            addChatMessage("Welcome! I'm here to assist you with any questions about our services, appointments, or mental health resources. How can I help you today?", 'bot');
            localStorage.setItem('chatWelcomed', 'true');
        }
    }, 3000);
}

function sendChatMessage() {
    const chatInput = document.getElementById('chatInput');
    const message = chatInput.value.trim();
    if (!message) return;
    
    // Add user message
    addChatMessage(message, 'user');
    chatInput.value = '';
    
    // Simulate typing
    setTimeout(() => {
        const responses = getChatResponse(message);
        addChatMessage(responses, 'bot');
    }, 1000 + Math.random() * 1000);
}

function addChatMessage(text, sender) {
    const chatBody = document.getElementById('chatBody');
    if (!chatBody) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}`;
    messageDiv.innerHTML = `
        <div class="message-content">${text}</div>
        <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
    `;
    chatBody.appendChild(messageDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
}

function getChatResponse(message) {
    const lowerMessage = message.toLowerCase();
    
    if (lowerMessage.includes('appointment') || lowerMessage.includes('schedule')) {
        return "To schedule an appointment, please use our contact form or call us at +254 759 226354. Would you prefer in-person or online sessions?";
    } else if (lowerMessage.includes('emergency') || lowerMessage.includes('crisis')) {
        return "For immediate crisis support, please call our emergency line at 0800 720 720 or use the crisis support buttons above.";
    } else if (lowerMessage.includes('fee') || lowerMessage.includes('price') || lowerMessage.includes('cost')) {
        return "We offer a sliding scale fee structure based on income. Please contact us for specific pricing details.";
    } else if (lowerMessage.includes('hours') || lowerMessage.includes('time')) {
        return "Our office hours are Monday-Friday 8AM-8PM, Saturday 9AM-4PM, and emergency support on Sundays.";
    } else if (lowerMessage.includes('location') || lowerMessage.includes('address') || lowerMessage.includes('where')) {
        return "We're located in Kahawa Wendani, Thika Road, Nairobi. You can get directions using the 'Get Directions' button above.";
    } else {
        const responses = [
            "Thank you for your message. How can I assist you further?",
            "I understand. Our team will review your concern and get back to you shortly.",
            "That's a common concern. Would you like me to connect you with a specialist?",
            "I'm here to help. Could you provide more details about what you're experiencing?",
            "We have resources available for that. Would you like me to direct you to our self-help guides?"
        ];
        return responses[Math.floor(Math.random() * responses.length)];
    }
}

// 5. Contact history system
function loadContactHistory() {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;
    
    const history = JSON.parse(localStorage.getItem('contactHistory') || '[]');
    
    if (history.length === 0) {
        historyList.innerHTML = `
            <div class="empty-history">
                <i class="fas fa-inbox"></i>
                <p>No messages yet. Your sent messages will appear here.</p>
            </div>
        `;
        return;
    }
    
    historyList.innerHTML = history.slice(0, 5).map(item => `
        <div class="history-item ${item.priority?.toLowerCase()}">
            <div class="history-meta">
                <span>${formatDate(item.timestamp || item.date)}</span>
                <span class="priority-badge">${item.priority || 'Low'}</span>
            </div>
            <div class="history-subject">${item.subject || 'No subject'}</div>
            <div class="history-preview">${item.message?.substring(0, 80) || ''}...</div>
            <div class="history-status">
                <i class="fas fa-check-circle"></i>
                <span>Sent</span>
            </div>
        </div>
    `).join('');
}

function clearHistory() {
    if (confirm('Are you sure you want to clear your message history?')) {
        localStorage.removeItem('contactHistory');
        loadContactHistory();
        showNotification('History cleared successfully', 'info');
    }
}

function exportHistory() {
    const history = JSON.parse(localStorage.getItem('contactHistory') || '[]');
    if (history.length === 0) {
        showNotification('No history to export', 'warning');
        return;
    }
    
    const dataStr = JSON.stringify(history, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = 'contact-history.json';
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification('History exported successfully', 'success');
}

// 6. Self-help tools
function showSelfHelpModal() {
    document.getElementById('selfHelpModal').style.display = 'flex';
}

function closeSelfHelpModal() {
    document.getElementById('selfHelpModal').style.display = 'none';
}

function startBreathingExercise() {
    const breathingHTML = `
        <div class="breathing-animation">
            <div class="breathing-circle"></div>
            <div class="breathing-instruction">Breathe in through your nose</div>
            <div class="breathing-timer">8 seconds</div>
            <button class="btn-stop-breathing" onclick="stopBreathingExercise()">
                Stop Exercise
            </button>
        </div>
    `;
    
    const div = document.createElement('div');
    div.innerHTML = breathingHTML;
    document.body.appendChild(div.firstElementChild);
    
    // Start timer
    let seconds = 0;
    const timer = setInterval(() => {
        seconds++;
        const cycle = seconds % 16;
        const timerEl = document.querySelector('.breathing-timer');
        const instructionEl = document.querySelector('.breathing-instruction');
        
        if (cycle < 8) {
            timerEl.textContent = `${8 - cycle} seconds`;
            instructionEl.textContent = 'Breathe in through your nose';
        } else if (cycle < 16) {
            timerEl.textContent = `${16 - cycle} seconds`;
            instructionEl.textContent = 'Breathe out through your mouth';
        }
    }, 1000);
    
    // Store timer reference
    div.firstElementChild.dataset.timer = timer;
}

function stopBreathingExercise() {
    const breathingEl = document.querySelector('.breathing-animation');
    if (breathingEl) {
        clearInterval(breathingEl.dataset.timer);
        breathingEl.remove();
    }
}

function startGroundingExercise() {
    const steps = [
        "Look around and name 5 things you can SEE",
        "Notice 4 things you can FEEL or TOUCH",
        "Listen for 3 things you can HEAR",
        "Identify 2 things you can SMELL",
        "Name 1 thing you can TASTE"
    ];
    
    let currentStep = 0;
    
    const modalHTML = `
        <div class="modal-overlay" id="groundingModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-mountain"></i> Grounding Exercise (5-4-3-2-1)</h3>
                    <button class="modal-close" onclick="closeGroundingModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="grounding-step">
                        <div class="step-number">${currentStep + 1}</div>
                        <div class="step-text">${steps[currentStep]}</div>
                    </div>
                    <div class="step-progress">
                        <div class="progress-bar" style="width: ${(currentStep + 1) * 20}%"></div>
                    </div>
                    <button class="btn-next-step" onclick="nextGroundingStep()">
                        ${currentStep < steps.length - 1 ? 'Next Step' : 'Finish'}
                    </button>
                </div>
            </div>
        </div>
    `;
    
    const div = document.createElement('div');
    div.innerHTML = modalHTML;
    document.body.appendChild(div.firstElementChild);
    
    // Store steps in global variable
    window.groundingSteps = steps;
    window.currentGroundingStep = currentStep;
}

function closeGroundingModal() {
    const modal = document.getElementById('groundingModal');
    if (modal) modal.remove();
}

function nextGroundingStep() {
    window.currentGroundingStep++;
    const modal = document.getElementById('groundingModal');
    if (!modal) return;
    
    if (window.currentGroundingStep < window.groundingSteps.length) {
        modal.querySelector('.step-number').textContent = window.currentGroundingStep + 1;
        modal.querySelector('.step-text').textContent = window.groundingSteps[window.currentGroundingStep];
        modal.querySelector('.progress-bar').style.width = `${(window.currentGroundingStep + 1) * 20}%`;
        modal.querySelector('.btn-next-step').textContent = 
            window.currentGroundingStep < window.groundingSteps.length - 1 ? 'Next Step' : 'Finish';
    } else {
        modal.querySelector('.grounding-step').innerHTML = `
            <i class="fas fa-check-circle" style="font-size: 3rem; color: #4CAF50;"></i>
            <div class="step-text">Exercise completed! How do you feel now?</div>
        `;
        modal.querySelector('.step-progress').style.display = 'none';
        modal.querySelector('.btn-next-step').textContent = 'Close';
        modal.querySelector('.btn-next-step').onclick = closeGroundingModal;
    }
}

function playCalmingAudio() {
    // Create audio context for calming sounds
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Create oscillator for calming sound
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Set to sine wave for smooth sound
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4 note
        
        // Gentle volume
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        
        oscillator.start();
        
        // Stop after 30 seconds
        setTimeout(() => {
            oscillator.stop();
            showNotification('Calming audio session ended', 'info');
        }, 30000);
        
        showNotification('Playing calming audio for 30 seconds...', 'info');
        
    } catch (error) {
        console.log('Audio not supported:', error);
        showNotification('Audio playback not supported in your browser', 'warning');
    }
}

// 7. Enhanced helper functions
function validateAllFields() {
    let isValid = true;
    const requiredFields = document.querySelectorAll('#contactForm [required]');
    
    requiredFields.forEach(field => {
        if (!validateField(field)) {
            isValid = false;
        }
    });
    
    return isValid;
}

function validateField(field) {
    const value = field.value.trim();
    const feedback = field.parentElement.querySelector('.input-feedback');
    
    if (field.required && !value) {
        showFieldError(field, 'This field is required');
        return false;
    }
    
    if (field.type === 'email' && value) {
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailPattern.test(value)) {
            showFieldError(field, 'Please enter a valid email address');
            return false;
        }
    }
    
    if (field.id === 'name' && value.length < 2) {
        showFieldError(field, 'Name must be at least 2 characters');
        return false;
    }
    
    if (field.id === 'message' && value.length < 10) {
        showFieldError(field, 'Message must be at least 10 characters');
        return false;
    }
    
    showFieldSuccess(field);
    return true;
}

function showFieldError(field, message) {
    const feedback = field.parentElement.querySelector('.input-feedback');
    feedback.textContent = message;
    feedback.className = 'input-feedback error';
    field.style.borderColor = '#f44336';
    field.style.background = '#fff5f5';
}

function showFieldSuccess(field) {
    const feedback = field.parentElement.querySelector('.input-feedback');
    feedback.textContent = '✓ Valid';
    feedback.className = 'input-feedback success';
    field.style.borderColor = '#4CAF50';
    field.style.background = '#f5fff5';
}

function clearFieldError(field) {
    const feedback = field.parentElement.querySelector('.input-feedback');
    feedback.textContent = '';
    feedback.className = 'input-feedback';
    field.style.borderColor = '#e0e0e0';
    field.style.background = 'white';
}

function saveMessageToHistory(data) {
    try {
        const history = JSON.parse(localStorage.getItem('contactHistory') || '[]');
        history.unshift({
            id: Date.now(),
            ...data,
            date: new Date().toISOString(),
            status: 'sent'
        });
        
        // Keep only last 20 messages
        if (history.length > 20) {
            history.pop();
        }
        
        localStorage.setItem('contactHistory', JSON.stringify(history));
        loadContactHistory();
    } catch (error) {
        console.error('Error saving to history:', error);
    }
}

function saveMessageToPending(data) {
    try {
        const pending = JSON.parse(localStorage.getItem('pendingMessages') || '[]');
        pending.push({
            ...data,
            id: Date.now(),
            date: new Date().toISOString(),
            retryCount: 0
        });
        
        localStorage.setItem('pendingMessages', JSON.stringify(pending));
    } catch (error) {
        console.error('Error saving to pending:', error);
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            <span>${message}</span>
            <button class="notification-close">&times;</button>
        </div>
    `;
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        animation: slideInRight 0.3s ease;
        max-width: 400px;
    `;
    
    document.body.appendChild(notification);
    
    // Close button
    notification.querySelector('.notification-close').addEventListener('click', () => {
        notification.remove();
    });
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

function playSuccessSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
        oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
        oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
    } catch (error) {
        console.log('Audio not supported');
    }
}

function updateStatusIndicator(status) {
    const statusItem = document.querySelector('.status-item.online');
    if (statusItem) {
        const icon = statusItem.querySelector('i');
        const text = statusItem.querySelector('span');
        
        switch(status) {
            case 'active':
                icon.className = 'fas fa-circle';
                icon.style.color = '#4CAF50';
                text.innerHTML = 'Email System: <strong>Active</strong>';
                break;
            case 'error':
                icon.className = 'fas fa-circle';
                icon.style.color = '#f44336';
                text.innerHTML = 'Email System: <strong>Error</strong>';
                break;
            case 'test':
                icon.className = 'fas fa-circle';
                icon.style.color = '#FFC107';
                text.innerHTML = 'Email System: <strong>Test Mode</strong>';
                break;
        }
    }
}

function setupEmergencyContacts() {
    const emergencyContact = document.querySelector('.emergency-contact');
    if (emergencyContact) {
        emergencyContact.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.02)';
            this.style.transition = 'transform 0.3s ease';
        });
        
        emergencyContact.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
        
        // Make emergency contacts clickable
        emergencyContact.querySelectorAll('li').forEach(li => {
            li.style.cursor = 'pointer';
            li.addEventListener('click', function() {
                const text = this.textContent;
                const number = text.match(/\d[\d\s\-]+/)?.[0];
                if (number) {
                    const cleanNumber = number.replace(/\s/g, '');
                    if (confirm(`Call ${cleanNumber}?`)) {
                        window.location.href = `tel:${cleanNumber}`;
                    }
                }
            });
        });
    }
}

function setupQuickButtons() {
    document.querySelectorAll('.quick-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
        });
    });
}

function setupTestimonials() {
    const testimonials = document.querySelectorAll('.testimonial-card');
    let currentIndex = 0;
    
    setInterval(() => {
        testimonials.forEach((card, index) => {
            card.style.opacity = index === currentIndex ? '1' : '0.5';
            card.style.transform = index === currentIndex ? 'scale(1.05)' : 'scale(1)';
        });
        
        currentIndex = (currentIndex + 1) % testimonials.length;
    }, 5000);
}

function checkEmailJSConfiguration() {
    if (EMAILJS_CONFIG.PUBLIC_KEY === "-jbh4-jMFMMjvpP-W" ||
        EMAILJS_CONFIG.SERVICE_ID === "service_b7urskv" ||
        EMAILJS_CONFIG.TEMPLATE_ID === "template_8zt7r2l") {
        console.log("EmailJS is configured with provided credentials");
        return true;
    }
    
    showNotification('Please configure EmailJS with your actual credentials', 'warning');
    return false;
}

function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        return 'Recently';
    }
}

// Add animation styles
const animationStyles = `
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

#emailStatus.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

#emailStatus.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

#emailStatus.sending {
    background: #cce5ff;
    color: #004085;
    border: 1px solid #b8daff;
}

.notification-content {
    display: flex;
    align-items: center;
    gap: 10px;
}

.notification-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    margin-left: auto;
}

.priority-dot.emergency {
    animation: pulse 1.5s infinite;
}

.empty-history {
    text-align: center;
    padding: 40px;
    color: #888;
}

.empty-history i {
    font-size: 3rem;
    margin-bottom: 15px;
    color: #e0e0e0;
}

.history-status {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 10px;
    color: #4CAF50;
    font-size: 0.9rem;
}

.step-progress {
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    margin: 20px 0;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: #6c63ff;
    border-radius: 4px;
    transition: width 0.3s ease;
}

.grounding-step {
    text-align: center;
    padding: 30px 0;
}

.step-number {
    font-size: 4rem;
    color: #6c63ff;
    font-weight: bold;
    margin-bottom: 20px;
}

.step-text {
    font-size: 1.2rem;
    color: #333;
    line-height: 1.6;
}

.btn-next-step {
    background: #6c63ff;
    color: white;
    border: none;
    padding: 12px 40px;
    border-radius: 50px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    display: block;
    margin: 0 auto;
    transition: all 0.3s;
}

.btn-next-step:hover {
    background: #4a43d4;
    transform: translateY(-2px);
}
`;

// Add styles to document
const styleSheet = document.createElement("style");
styleSheet.textContent = animationStyles;
document.head.appendChild(styleSheet);
</script>

<!-- Include EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<!-- Fallback email function -->
<script>
async function sendWithFallback(formData) {
    // This is a placeholder for a fallback email service
    // You could integrate with another service like Formspree here
    console.log('Fallback email sending:', formData);
    
    // Simulate success for demo purposes
    return new Promise((resolve) => {
        setTimeout(() => resolve({ status: 200 }), 1000);
    });
}
</script>
